<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.todoapp.Mapper.PersonMapper">

    <!-- 动态更新部分字段（基于id主键） -->
    <!-- 在update语句前添加存在性检查 -->
    <update id="updateById">
        <!-- 添加防重复检查 -->
        <selectKey keyProperty="count" resultType="int" order="BEFORE">
            SELECT COUNT(*) FROM person
            WHERE userId = #{userId}
            AND title = #{title}
            AND id != #{id}
        </selectKey>

        UPDATE person SET
        title = #{title},
        userId = #{userId},
        description = #{description},
        category = #{category},
        status = #{status},
        dueDate = #{dueDate},
        remindTime = #{remindTime}
        WHERE id = #{id}
    </update>

    <!-- 组合搜索（支持动态条件） -->
    <select id="searchByConditions" resultType="com.todoapp.pojo.Person">
        SELECT * FROM person
        <where>
            <if test="userId != null and userId != ''">AND userId = #{userId}</if>
            <if test="title != null and title != ''">AND title LIKE CONCAT('%', #{title}, '%')</if>
            <if test="category != null and category != ''">AND category = #{category}</if>
        </where>
    </select>

</mapper>